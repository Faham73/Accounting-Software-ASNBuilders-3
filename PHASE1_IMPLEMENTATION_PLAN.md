# Phase 1 Implementation Plan
## Core Foundation: Multi-Company + Master Data Models

**Goal:** Implement Company → Projects → Vendors → CostHeads → PaymentMethods hierarchy with company-scoped data and Attachment model foundation.

---

## 1. Prisma Schema Changes

### File: `packages/db/prisma/schema.prisma`

**Changes:**
- Add `isActive` boolean field to `Company` model (optional soft delete)
- Add `Project` model:
  - `id` (String, cuid)
  - `name` (String, required)
  - `code` (String, optional - project code/identifier)
  - `description` (String, optional)
  - `companyId` (String, FK to Company, required)
  - `isActive` (Boolean, default true)
  - `createdAt` (DateTime, default now)
  - `updatedAt` (DateTime, default now, updatedAt)
  - Relation: `company Company @relation(fields: [companyId], references: [id])`
  - Index: `@@index([companyId])`
  - Map: `@@map("projects")`

- Add `Vendor` model:
  - `id` (String, cuid)
  - `name` (String, required)
  - `contactPerson` (String, optional)
  - `email` (String, optional)
  - `phone` (String, optional)
  - `address` (String, optional)
  - `companyId` (String, FK to Company, required)
  - `isActive` (Boolean, default true)
  - `createdAt` (DateTime, default now)
  - `updatedAt` (DateTime, default now, updatedAt)
  - Relation: `company Company @relation(fields: [companyId], references: [id])`
  - Index: `@@index([companyId])`
  - Map: `@@map("vendors")`

- Add `CostHead` model:
  - `id` (String, cuid)
  - `name` (String, required)
  - `code` (String, optional - cost head code)
  - `description` (String, optional)
  - `companyId` (String, FK to Company, required)
  - `isActive` (Boolean, default true)
  - `createdAt` (DateTime, default now)
  - `updatedAt` (DateTime, default now, updatedAt)
  - Relation: `company Company @relation(fields: [companyId], references: [id])`
  - Index: `@@index([companyId])`
  - Map: `@@map("cost_heads")`

- Add `PaymentMethod` model:
  - `id` (String, cuid)
  - `name` (String, required) - e.g., "Cash", "Bank Transfer", "Cheque"
  - `code` (String, optional)
  - `description` (String, optional)
  - `companyId` (String, FK to Company, required)
  - `isActive` (Boolean, default true)
  - `createdAt` (DateTime, default now)
  - `updatedAt` (DateTime, default now, updatedAt)
  - Relation: `company Company @relation(fields: [companyId], references: [id])`
  - Index: `@@index([companyId])`
  - Map: `@@map("payment_methods")`

- Add `Attachment` model:
  - `id` (String, cuid)
  - `fileName` (String, required)
  - `url` (String, required) - storage URL/path
  - `mimeType` (String, required) - e.g., "image/png", "application/pdf"
  - `size` (Int, required) - file size in bytes
  - `companyId` (String, FK to Company, required)
  - `uploadedByUserId` (String, FK to User, required)
  - `createdAt` (DateTime, default now)
  - Relations:
    - `company Company @relation(fields: [companyId], references: [id])`
    - `uploadedBy User @relation(fields: [uploadedByUserId], references: [id])`
  - Indexes: `@@index([companyId])`, `@@index([uploadedByUserId])`
  - Map: `@@map("attachments")`

- Update `Company` model:
  - Add `isActive` (Boolean, default true)
  - Add `updatedAt` (DateTime, default now, updatedAt)
  - Add relations:
    - `projects Project[]`
    - `vendors Vendor[]`
    - `costHeads CostHead[]`
    - `paymentMethods PaymentMethod[]`
    - `attachments Attachment[]`

- Update `User` model:
  - Add relation: `uploadedAttachments Attachment[]`

---

## 2. Database Migrations

### File: `packages/db/prisma/migrations/[timestamp]_add_phase1_models/migration.sql`

**Migration Steps:**
1. Add `is_active` and `updated_at` columns to `companies` table
2. Create `projects` table with all fields
3. Create `vendors` table with all fields
4. Create `cost_heads` table with all fields
5. Create `payment_methods` table with all fields
6. Create `attachments` table with all fields
7. Add foreign key constraints
8. Add indexes on `companyId` columns
9. Add index on `uploadedByUserId` in attachments

**Note:** Migration will be auto-generated by Prisma when running `npx prisma migrate dev --name add_phase1_models`

---

## 3. Seed File Updates

### File: `packages/db/prisma/seed.ts`

**Changes:**
- Keep existing user creation logic
- After creating companies and users, add seed data for each company:
  - Create sample Projects (2-3 per company)
  - Create sample Vendors (2-3 per company)
  - Create sample CostHeads (3-5 per company)
  - Create sample PaymentMethods (3-4 per company)
  - Optionally create sample Attachments (1-2 per company)

**Seed Data Structure:**
```typescript
// For each company (including default company):
- Projects: "Project Alpha", "Project Beta"
- Vendors: "Vendor A", "Vendor B"
- CostHeads: "Materials", "Labor", "Equipment", "Overhead"
- PaymentMethods: "Cash", "Bank Transfer", "Cheque", "Credit Card"
```

**Important:** Seed should work for any company, not hardcode company IDs. Use the company from the loop.

---

## 4. API Route Handlers

### Pattern: All API routes follow this structure:
- Use `requireAuth()` or `requirePermission()` from `@/lib/rbac`
- Always filter by `companyId` from auth context (never from client)
- Return consistent format: `{ ok: boolean, data?: any, error?: string }`
- Handle errors with `createErrorResponse()`
- Support GET (list), GET with id (single), POST (create), PUT/PATCH (update), DELETE (soft delete via isActive)

### 4.1 Companies API (Admin Only)

**File:** `apps/web/app/api/companies/route.ts`
- **GET:** List all companies (admin only)
  - Use `requireAdmin(request)`
  - Return all companies
- **POST:** Create new company (admin only)
  - Use `requireAdmin(request)`
  - Body: `{ name: string }`
  - Create company, return created company

**File:** `apps/web/app/api/companies/[id]/route.ts`
- **GET:** Get single company by id (admin only)
- **PUT:** Update company (admin only)
  - Body: `{ name?: string, isActive?: boolean }`
- **DELETE:** Soft delete company (admin only)
  - Set `isActive = false`

### 4.2 Projects API

**File:** `apps/web/app/api/projects/route.ts`
- **GET:** List projects for user's company
  - Use `requirePermission(request, 'projects', 'READ')`
  - Filter: `where: { companyId: auth.companyId, isActive: true }`
  - Return projects array
- **POST:** Create project (requires WRITE permission)
  - Use `requirePermission(request, 'projects', 'WRITE')`
  - Body: `{ name: string, code?: string, description?: string }`
  - Set `companyId` from auth context
  - Return created project

**File:** `apps/web/app/api/projects/[id]/route.ts`
- **GET:** Get single project by id
  - Use `requirePermission(request, 'projects', 'READ')`
  - Filter: `where: { id, companyId: auth.companyId }`
- **PUT:** Update project (requires WRITE permission)
  - Use `requirePermission(request, 'projects', 'WRITE')`
  - Body: `{ name?: string, code?: string, description?: string, isActive?: boolean }`
  - Filter: `where: { id, companyId: auth.companyId }`
- **DELETE:** Soft delete project (requires WRITE permission)
  - Set `isActive = false`

### 4.3 Vendors API

**File:** `apps/web/app/api/vendors/route.ts`
- **GET:** List vendors for user's company
  - Use `requirePermission(request, 'vendors', 'READ')`
  - Filter: `where: { companyId: auth.companyId, isActive: true }`
- **POST:** Create vendor (requires WRITE permission)
  - Use `requirePermission(request, 'vendors', 'WRITE')`
  - Body: `{ name: string, contactPerson?: string, email?: string, phone?: string, address?: string }`
  - Set `companyId` from auth context

**File:** `apps/web/app/api/vendors/[id]/route.ts`
- **GET:** Get single vendor by id
- **PUT:** Update vendor (requires WRITE permission)
  - Body: `{ name?: string, contactPerson?: string, email?: string, phone?: string, address?: string, isActive?: boolean }`
- **DELETE:** Soft delete vendor (requires WRITE permission)

### 4.4 Cost Heads API

**File:** `apps/web/app/api/cost-heads/route.ts`
- **GET:** List cost heads for user's company
  - Use `requirePermission(request, 'costHeads', 'READ')`
  - Filter: `where: { companyId: auth.companyId, isActive: true }`
- **POST:** Create cost head (requires WRITE permission)
  - Use `requirePermission(request, 'costHeads', 'WRITE')`
  - Body: `{ name: string, code?: string, description?: string }`
  - Set `companyId` from auth context

**File:** `apps/web/app/api/cost-heads/[id]/route.ts`
- **GET:** Get single cost head by id
- **PUT:** Update cost head (requires WRITE permission)
  - Body: `{ name?: string, code?: string, description?: string, isActive?: boolean }`
- **DELETE:** Soft delete cost head (requires WRITE permission)

### 4.5 Payment Methods API

**File:** `apps/web/app/api/payment-methods/route.ts`
- **GET:** List payment methods for user's company
  - Use `requirePermission(request, 'paymentMethods', 'READ')`
  - Filter: `where: { companyId: auth.companyId, isActive: true }`
- **POST:** Create payment method (requires WRITE permission)
  - Use `requirePermission(request, 'paymentMethods', 'WRITE')`
  - Body: `{ name: string, code?: string, description?: string }`
  - Set `companyId` from auth context

**File:** `apps/web/app/api/payment-methods/[id]/route.ts`
- **GET:** Get single payment method by id
- **PUT:** Update payment method (requires WRITE permission)
  - Body: `{ name?: string, code?: string, description?: string, isActive?: boolean }`
- **DELETE:** Soft delete payment method (requires WRITE permission)

### 4.6 Attachments API (Foundation Only)

**File:** `apps/web/app/api/attachments/route.ts`
- **GET:** List attachments for user's company
  - Use `requirePermission(request, 'projects', 'READ')` (or create new permission later)
  - Filter: `where: { companyId: auth.companyId }`
  - Include: `uploadedBy: { select: { id, name, email } }`
- **POST:** Create attachment metadata (requires WRITE permission)
  - Use `requirePermission(request, 'projects', 'WRITE')` (or create new permission later)
  - Body: `{ fileName: string, url: string, mimeType: string, size: number }`
  - Set `companyId` and `uploadedByUserId` from auth context
  - Return created attachment

**File:** `apps/web/app/api/attachments/[id]/route.ts`
- **GET:** Get single attachment by id
  - Filter: `where: { id, companyId: auth.companyId }`
- **DELETE:** Delete attachment (requires WRITE permission)
  - Hard delete (no soft delete for attachments)

**Note:** Actual file upload handling can be added later. For now, just metadata creation.

---

## 5. UI Pages (Dashboard Routes)

### Pattern: All UI pages follow this structure:
- Use `requirePermissionServer()` or `requireAdminServer()` for auth
- Redirect to `/forbidden` on error
- Show list view with create/edit/delete actions based on permissions
- Use client components for forms and interactions
- Always filter data by user's company (handled in API calls)

### 5.1 Companies Page (Admin Only)

**File:** `apps/web/app/dashboard/companies/page.tsx`
- **Changes:**
  - Add table/list of companies
  - Add "Create Company" button (admin only)
  - Show: Name, Created At, Is Active
  - Actions: Edit, Delete (soft delete)
  - Use client component for form interactions

**New File:** `apps/web/app/dashboard/companies/[id]/page.tsx` (optional, for edit view)
- Edit company form

### 5.2 Projects Page

**File:** `apps/web/app/dashboard/projects/page.tsx`
- **Changes:**
  - Add table/list of projects (filtered by company)
  - Add "Create Project" button (if WRITE permission)
  - Show: Name, Code, Description, Created At, Is Active
  - Actions: Edit, Delete (if WRITE permission)
  - Use client component for form interactions

**New File:** `apps/web/app/dashboard/projects/[id]/page.tsx` (optional, for edit view)
- Edit project form

### 5.3 Vendors Page

**File:** `apps/web/app/dashboard/vendors/page.tsx`
- **Changes:**
  - Add table/list of vendors (filtered by company)
  - Add "Create Vendor" button (if WRITE permission)
  - Show: Name, Contact Person, Email, Phone, Created At, Is Active
  - Actions: Edit, Delete (if WRITE permission)
  - Use client component for form interactions

**New File:** `apps/web/app/dashboard/vendors/[id]/page.tsx` (optional, for edit view)
- Edit vendor form

### 5.4 Cost Heads Page

**File:** `apps/web/app/dashboard/cost-heads/page.tsx`
- **Changes:**
  - Add table/list of cost heads (filtered by company)
  - Add "Create Cost Head" button (if WRITE permission)
  - Show: Name, Code, Description, Created At, Is Active
  - Actions: Edit, Delete (if WRITE permission)
  - Use client component for form interactions

**New File:** `apps/web/app/dashboard/cost-heads/[id]/page.tsx` (optional, for edit view)
- Edit cost head form

### 5.5 Payment Methods Page

**File:** `apps/web/app/dashboard/payment-methods/page.tsx`
- **Changes:**
  - Add table/list of payment methods (filtered by company)
  - Add "Create Payment Method" button (if WRITE permission)
  - Show: Name, Code, Description, Created At, Is Active
  - Actions: Edit, Delete (if WRITE permission)
  - Use client component for form interactions

**New File:** `apps/web/app/dashboard/payment-methods/[id]/page.tsx` (optional, for edit view)
- Edit payment method form

### 5.6 Attachments Page (Optional - Foundation Only)

**File:** `apps/web/app/dashboard/attachments/page.tsx` (optional for Phase 1)
- Basic list view of attachments
- Show: File Name, MIME Type, Size, Uploaded By, Created At
- Basic upload UI (can be minimal for Phase 1)

---

## 6. Client Components (Forms & Interactions)

### Location: `apps/web/app/dashboard/[resource]/components/`

**New Components Needed:**
- `ProjectForm.tsx` - Create/Edit project form
- `VendorForm.tsx` - Create/Edit vendor form
- `CostHeadForm.tsx` - Create/Edit cost head form
- `PaymentMethodForm.tsx` - Create/Edit payment method form
- `CompanyForm.tsx` - Create/Edit company form (admin only)
- `AttachmentUpload.tsx` - Basic upload component (optional for Phase 1)

**Pattern:**
- Use React Hook Form or similar
- Call API routes via `fetch()`
- Handle loading/error states
- Redirect or refresh on success

---

## 7. Type Definitions

### File: `packages/db/src/types.ts` (or similar, if needed)

**Types to Export:**
- Project, Vendor, CostHead, PaymentMethod, Attachment types
- API request/response types
- Form data types

**Note:** Prisma Client will auto-generate types, but we may want additional types for API responses.

---

## 8. Utility Functions

### File: `apps/web/lib/api.ts` (new file, optional)

**Helper functions for API calls:**
- `fetchProjects()`, `createProject()`, `updateProject()`, `deleteProject()`
- Similar for vendors, cost-heads, payment-methods, attachments, companies
- Handle auth cookies automatically
- Consistent error handling

---

## 9. Summary of Files to Create/Modify

### Database Layer:
- ✅ `packages/db/prisma/schema.prisma` - **MODIFY**
- ✅ `packages/db/prisma/migrations/[timestamp]_add_phase1_models/migration.sql` - **CREATE** (auto-generated)
- ✅ `packages/db/prisma/seed.ts` - **MODIFY**

### API Routes (13 files):
- ✅ `apps/web/app/api/companies/route.ts` - **CREATE**
- ✅ `apps/web/app/api/companies/[id]/route.ts` - **CREATE**
- ✅ `apps/web/app/api/projects/route.ts` - **CREATE**
- ✅ `apps/web/app/api/projects/[id]/route.ts` - **CREATE**
- ✅ `apps/web/app/api/vendors/route.ts` - **CREATE**
- ✅ `apps/web/app/api/vendors/[id]/route.ts` - **CREATE**
- ✅ `apps/web/app/api/cost-heads/route.ts` - **CREATE**
- ✅ `apps/web/app/api/cost-heads/[id]/route.ts` - **CREATE**
- ✅ `apps/web/app/api/payment-methods/route.ts` - **CREATE**
- ✅ `apps/web/app/api/payment-methods/[id]/route.ts` - **CREATE**
- ✅ `apps/web/app/api/attachments/route.ts` - **CREATE**
- ✅ `apps/web/app/api/attachments/[id]/route.ts` - **CREATE**

### UI Pages (6 files to modify, 5 optional detail pages):
- ✅ `apps/web/app/dashboard/companies/page.tsx` - **MODIFY**
- ✅ `apps/web/app/dashboard/projects/page.tsx` - **MODIFY**
- ✅ `apps/web/app/dashboard/vendors/page.tsx` - **MODIFY**
- ✅ `apps/web/app/dashboard/cost-heads/page.tsx` - **MODIFY**
- ✅ `apps/web/app/dashboard/payment-methods/page.tsx` - **MODIFY**
- ⚠️ `apps/web/app/dashboard/attachments/page.tsx` - **CREATE** (optional for Phase 1)
- ⚠️ Detail/edit pages for each resource - **CREATE** (optional, can use modals instead)

### Client Components (5-6 files):
- ✅ `apps/web/app/dashboard/companies/components/CompanyForm.tsx` - **CREATE**
- ✅ `apps/web/app/dashboard/projects/components/ProjectForm.tsx` - **CREATE**
- ✅ `apps/web/app/dashboard/vendors/components/VendorForm.tsx` - **CREATE**
- ✅ `apps/web/app/dashboard/cost-heads/components/CostHeadForm.tsx` - **CREATE**
- ✅ `apps/web/app/dashboard/payment-methods/components/PaymentMethodForm.tsx` - **CREATE**
- ⚠️ `apps/web/app/dashboard/attachments/components/AttachmentUpload.tsx` - **CREATE** (optional)

### Utilities (optional):
- ⚠️ `apps/web/lib/api.ts` - **CREATE** (optional helper file)

---

## 10. Implementation Order

1. **Database Layer:**
   - Update Prisma schema
   - Generate and run migration
   - Update seed file

2. **API Routes:**
   - Companies API (admin only)
   - Projects API
   - Vendors API
   - Cost Heads API
   - Payment Methods API
   - Attachments API

3. **UI Pages:**
   - Update existing dashboard pages with CRUD functionality
   - Create form components
   - Add client-side interactions

4. **Testing:**
   - Test with different user roles
   - Verify company scoping works correctly
   - Verify permissions are enforced

---

## 11. Key Implementation Notes

### Security:
- ✅ **Never trust client-provided companyId** - Always use `auth.companyId` from auth context
- ✅ **Always check permissions** - Use `requirePermission()` or `requireAdmin()` before operations
- ✅ **Filter by companyId** - All queries must include `companyId: auth.companyId` filter

### Data Scoping:
- All master data (Projects, Vendors, CostHeads, PaymentMethods) is scoped by `companyId`
- Users belong to ONE company (enforced by User model)
- Admin can see all companies, but regular users only see their company's data

### Soft Deletes:
- Use `isActive` boolean for soft deletes on master data
- Attachments use hard delete (no `isActive` field)
- Filter out inactive records in list views (unless admin viewing all)

### API Response Format:
```typescript
// Success:
{ ok: true, data: T }

// Error:
{ ok: false, error: string }
```

### Error Handling:
- 401 Unauthorized - Not authenticated
- 403 Forbidden - No permission
- 404 Not Found - Resource not found or not in user's company
- 500 Internal Server Error - Server error

---

## 12. Testing Checklist

- [ ] Admin can create companies
- [ ] Admin can see all companies
- [ ] Regular users only see their company's data
- [ ] Projects CRUD works with company scoping
- [ ] Vendors CRUD works with company scoping
- [ ] Cost Heads CRUD works with company scoping
- [ ] Payment Methods CRUD works with company scoping
- [ ] Attachments metadata creation works
- [ ] Permissions are enforced (READ/WRITE)
- [ ] Soft delete works (isActive = false)
- [ ] Seed data creates defaults per company
- [ ] No hardcoded company IDs in code

---

**End of Plan**
